<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wddyxd.productservice.mapper.CouponMapper">

    <!-- ====================== 通用SQL片段 ====================== -->
    <!-- 1. Coupon主表核心字段（排除冗余） -->
    <sql id="couponCoreFields">
        c.id,
        c.name,
        c.get_type,
        c.target_type,
        c.is_discount,
        c.target_id,
        c.threshold,
        c.value,
        c.start_time,
        c.end_time,
        c.stock,
        c.sending_stock,
        c.status,
        c.create_time,
        c.update_time,
        c.is_deleted
    </sql>

    <!-- 2. Pointer字段赋值逻辑（统一复用） -->
    <sql id="pointerField">
        CASE
            WHEN c.target_type = 0 THEN '平台通用'
            WHEN c.target_type = 1 THEN COALESCE(u.username, '无效商户')
            WHEN c.target_type = 2 THEN COALESCE(p.name, '无效商品')
            ELSE '未知类型'
        END AS pointer
    </sql>

    <!-- 3. Coupon基础过滤条件（未删除、生效中、有效期内） -->
    <sql id="couponValidFilter">
        c.is_deleted = 0
    AND c.status = 1
    AND c.start_time &lt;= NOW()
    AND c.end_time &gt;= NOW()
    </sql>

    <!-- 4. 商品关联逻辑（用于匹配商户ID） -->
    <sql id="productJoinLogic">
        INNER JOIN product current_p ON current_p.id = #{productId} AND current_p.is_deleted = 0
    </sql>

    <!-- 5. 用户/商品左连接逻辑（用于pointer字段） -->
    <sql id="leftJoinUserProduct">
        LEFT JOIN `user` u ON c.target_type = 1 AND c.target_id = u.id
        LEFT JOIN product p ON c.target_type = 2 AND c.target_id = p.id
    </sql>

    <!-- ====================== 结果映射 ====================== -->
    <resultMap id="CouponVOMap" type="com.wddyxd.productservice.pojo.VO.CouponVO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="get_type" property="getType"/>
        <result column="target_type" property="targetType"/>
        <result column="is_discount" property="isDiscount"/>
        <result column="target_id" property="targetId"/>
        <result column="threshold" property="threshold"/>
        <result column="value" property="value"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="stock" property="stock"/>
        <result column="sending_stock" property="sendingStock"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="pointer" property="pointer"/>
    </resultMap>

    <!-- ====================== 业务查询方法 ====================== -->
    <!-- 1. 分页查询优惠券VO -->
    <select id="getPageCouponVO" resultMap="CouponVOMap">
        SELECT
        <include refid="couponCoreFields"/>,
        <include refid="pointerField"/>
        FROM coupon c
        <include refid="leftJoinUserProduct"/>
        WHERE c.is_deleted = 0
        <if test="search != null and search != ''">
            AND c.name LIKE CONCAT('%', #{search}, '%')
        </if>
        ORDER BY c.update_time DESC
    </select>

    <!-- 2. 查询商品可用的所有有效优惠券 -->
    <select id="detailCouponVO" resultMap="CouponVOMap">
        SELECT
        <include refid="couponCoreFields"/>,
        <include refid="pointerField"/>
        FROM coupon c
        <include refid="leftJoinUserProduct"/>
        <include refid="productJoinLogic"/>
        WHERE
        <include refid="couponValidFilter"/>
        AND (
        c.target_type = 0  -- 全场通用
        OR (c.target_type = 1 AND c.target_id = current_p.user_id)  -- 商品所属商户
        OR (c.target_type = 2 AND c.target_id = #{productId})  -- 指定商品
        )
        -- 优惠力度排序：满减优先按金额降序，折扣优先按比例降序
        ORDER BY
        CASE WHEN c.get_type = 0 THEN c.value ELSE 0 END DESC,
        CASE WHEN c.get_type = 1 THEN c.value ELSE 0 END DESC
    </select>

    <!-- 3. 查询用户已领取的商品可用优惠券 -->
    <select id="visitCouponVO" resultMap="CouponVOMap">
        SELECT
        <include refid="couponCoreFields"/>,
        <include refid="pointerField"/>,
        uc.get_time AS getTime  -- 用户领取时间
        FROM user_coupon uc
        INNER JOIN coupon c ON uc.coupon_id = c.id
        <include refid="leftJoinUserProduct"/>
        <include refid="productJoinLogic"/>
        WHERE
        -- 用户优惠券过滤
        uc.user_id = #{userId}
        AND uc.is_deleted = 0
        AND uc.status = 0  -- 未使用（status=2已过期已被couponValidFilter覆盖，移除冗余判断）
        -- 优惠券基础过滤
        AND <include refid="couponValidFilter"/>
        -- 商品匹配规则
        AND (
        c.target_type = 0
        OR (c.target_type = 1 AND c.target_id = current_p.user_id)
        OR (c.target_type = 2 AND c.target_id = #{productId})
        )
        -- 优先展示快过期的优惠券
        ORDER BY c.end_time ASC
    </select>

</mapper>