# 接口文档
---
## 用户模块 user-service
### 认证相关接口 AuthController
#### 用户登录接口
##### 基础信息
- **接口名称**: 用户登录
- **接口路径**: `/api/user/auth/login`
- **请求方法**: POST
- **接口权限**:任何用户可访问
- **接口描述**: 在前端任何客户端按下登录按钮时触发,可以用用户名/手机/邮箱进行密码登录,
- 同时可以用手机或邮箱进行验证码登录,通用在用户端,商户端和管理端,
- 需要标明是用密码还是验证码登录,需要标明是在哪个端登录,需要获取用户的IP和设备,
- 登录成功后返回token,token有效时间是7天,
- **接口实现**:前端传入UserLoginForm,然后这个请求被springSecurity过滤器链捕捉,在被判断是登录接口后被TokenLoginFilter拦截后,从HttpRequest解析表单数据并判断登录的类型并加工表单.
- 加工完成后被LoginAuthenticationToken包装并交给AuthenticationManager的实现类链AuthenticationProvider,
- AuthenticationProvider根据LoginAuthenticationToken包装的数据调用不同的UserDetailService来获取用户信息,
- 调用远程接口AuthController的相关方法,首先从redis拿,拿不到就去mysql拿. 并包装到UserDetail的实现类,
- 然后在密码加工(目前用MD5加工密码)比较器判断密码/验证码是否吻合,最后回到TokenLoginFilter来生成token(用对称加密生成)token包装用户id,timestamp,ip,device并设置7天有效期.
- 然后将用户信息保存到redis14天有效期,最后给前端返回token.
##### 请求参数
###### 请求头
| 参数名             | 是否必填      | 数据类型   | 说明                          | 示例                                        |
|-----------------|-----------|--------|-----------------------------|-------------------------------------------|
| Content-Type    | 是         | string | 请求体类型                       | application/json                          |
| User-Agent      | 否         | string | 客户端设备及浏览器信息                 | Mozilla/5.0 (Windows NT 10.0; Win64; x64) |
| X-Real-IP       | 否（由代理层传递） | string | 客户端公网 IP（通常由 Nginx 等反向代理设置） | 220.181.38.148                            |
| X-Forwarded-For | 否（由代理层传递） | string | 经过代理的客户端 IP 链               | 220.181.38.148, 10.0.0.1                  |
| X-Local-IP      | 否         | string | 客户端局域网 IP（前端自定义传递）          | 192.168.1.100                             |

###### 请求体
| 参数名       | 是否必填        | 数据类型   | 说明    | 示例                  |
|-----------|-------------|--------|-------|---------------------|
| id        | 否           | Long   | id    | 1984531291470573570 |
| username  | 绑定loginType | string | 用户名   | admin               |
| phone     | 绑定loginType | string | 手机号   | 13800000000         |
| email     | 绑定loginType | string | 邮箱    | 111111111@qq.com    |
| password  | 绑定loginType | string | 密码    | 123456              |
| phoneCode | 绑定loginType | string | 手机验证码 | 123456              |
| emailCode | 绑定loginType | string | 邮箱验证码 | 123456              |
| loginType | 是           | string | 登录类型  | password            |
| client    | 是           | string | 客户端   | user                |


##### 响应数据
###### 响应状态码
- 200: 请求成功
- 400: 请求参数错误
- 401: 用户名或密码错误
- 500: 服务器错误

###### 响应体
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```


#### 用户登录接口
##### 基础信息
- **接口名称**: 密码登录
- **接口路径**: `/api/user/auth/passwordSecurityGetter/{username}`
- **请求方法**: GET
- **接口权限**:任何用户可访问
- **接口描述**: 在用户登录接口触发时如果登录类型为password则触发,可以用用户名/手机/邮箱根据密码获取用户信息,
- 得到用户信息后返回UserDetail对象
- **接口实现**:PasswordUserDetailServiceImpl调用该接口,调用数据库得到用户基本信息来得到密码,然后从redis得到用户信息,
- 拿不到就去mysql拿. 包装到UserDetail的实现类SecurityUser并返回
##### 请求参数
###### 请求头
| 参数名             | 是否必填      | 数据类型   | 说明                          | 示例                                        |
|-----------------|-----------|--------|-----------------------------|-------------------------------------------|
| Content-Type    | 是         | string | 请求体类型                       | application/json                          |

###### 请求体
| 参数名       | 是否必填 | 数据类型   | 说明    | 示例                  |
|-----------|------|--------|-------|---------------------|
| username  | 是    | string | 用户名   | admin               |


##### 响应数据
###### 响应状态码
- 200: 请求成功
- 400: 请求参数错误
- 401: 用户名或密码错误
- 500: 服务器错误

###### 响应体
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "loginUserForm": {
      "id": 1,
      "username": "wddyxd",
      "password": "202cb962ac59075b964b07152d234b70",
      "phone": "15626448742",
      "phoneCode": null,
      "email": "www778005729@qq.com",
      "emailCode": null,
      "loginType": null,
      "client": null
    },
    "currentUserInfo": {
      "id": 1,
      "username": "wddyxd",
      "nickName": "wddyxd",
      "avatar": "",
      "roles": [
        "ROLE_SUPER_ADMIN"
      ],
      "permissionValueList": [
        "user.add",
        "user.update",
        "user.list",
        "user.remove"
      ]
    }
  }
}
```
